name: SMTP Debug

on:
  workflow_dispatch:

jobs:
  smtp-test:
    runs-on: ubuntu-latest
    env:
      MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
    steps:
      - name: Test SMTP login
        run: |
          python3 - <<'PY'
          import smtplib, ssl, os, sys
          user=os.getenv('MAIL_USERNAME')
          pw=os.getenv('EMAIL_PASSWORD')
          if not user or not pw:
              print('MISSING_SECRETS')
              sys.exit(2)
          try:
              s=smtplib.SMTP('smtp.office365.com',587,timeout=30)
              s.ehlo()
              s.starttls()
              res = None
              try:
                  res = s.login(user,pw)
                  print('LOGIN_SUCCESS', res)
              except Exception as e:
                  print('LOGIN_FAILED', repr(e))
                  raise
              finally:
                  try: s.quit()
                  except: pass
          except Exception as e:
              print('SMTP_CONNECTION_ERROR', repr(e))
              sys.exit(1)
          print('SMTP_TEST_DONE')
          PY
