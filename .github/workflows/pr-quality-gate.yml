name: PR Quality Gate

on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches:
            - main
            - develop

jobs:
    quality-gate:
        name: Quality Gate Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: "maven"

            - name: Cache Maven packages
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            - name: Build and Test
              run: mvn clean verify

            - name: Generate Coverage Report
              run: mvn jacoco:report

            - name: Check Code Coverage
              run: |
                  COVERAGE=$(grep -oP '(?<=<counter type="LINE" missed=")[0-9]+' */target/site/jacoco/jacoco.xml | head -1 || echo "0")
                  TOTAL=$(grep -oP '(?<=covered=")[0-9]+' */target/site/jacoco/jacoco.xml | head -1 || echo "100")

                  if [ "$TOTAL" -gt 0 ]; then
                    PERCENT=$((TOTAL * 100 / (TOTAL + COVERAGE)))
                    echo "Code coverage: $PERCENT%"
                    
                    if [ "$PERCENT" -lt 80 ]; then
                      echo "::error::Code coverage is below 80% threshold"
                      exit 1
                    fi
                  fi

            - name: SonarQube Scan
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
              run: |
                  mvn sonar:sonar \
                    -Dsonar.projectKey=safe-zone \
                    -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
                    -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
                    -Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
                    -Dsonar.pullrequest.branch=${{ github.head_ref }} \
                    -Dsonar.pullrequest.base=${{ github.base_ref }} \
                    -Dsonar.qualitygate.wait=true

            - name: Quality Gate Status
              if: failure()
              run: |
                  echo "::error::Quality Gate failed. Please fix the issues before merging."
                  exit 1

    lint-check:
        name: Code Style Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: "maven"

            - name: Check code style with Checkstyle
              run: mvn checkstyle:check || true

            - name: Check with SpotBugs
              run: mvn spotbugs:check || true

    approve-check:
        name: Approval Check
        runs-on: ubuntu-latest
        needs: [quality-gate, lint-check]

        steps:
            - name: Check for approvals
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: reviews } = await github.rest.pulls.listReviews({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.issue.number
                      });

                      const approvals = reviews.filter(r => r.state === 'APPROVED');

                      if (approvals.length < 1) {
                        core.setFailed('At least 1 approval is required');
                      }
